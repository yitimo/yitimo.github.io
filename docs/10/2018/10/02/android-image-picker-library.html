<!DOCTYPE html>
<html>
<head>
    <title>Android 编写一个图片选择器 | 再见二丁目</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <h1>Android 编写一个图片选择器</h1>
    <div><p>笔者项目中遇到需要选择图片的情况，一开始直接使用的是知乎开源的<a href="https://github.com/zhihu/Matisse">Matisse</a>，(下文要讲述的自己实现的图片选择工具也从中参考了一些实现)。至于之后为什么要选择自己来实现一个选择器，原因大概如下：</p>
<ol>
<li>难度不高(很大的原因是因为把图片渲染工作交给了<code>Glide</code>)</li>
<li>想要自己深度定制</li>
<li>第2点的定制内容比如：<strong>第一次选择好图片后，再次进入图片选择器支持记录上次已选中的图片</strong>。</li>
</ol>
<h2>实现思路</h2>
<p>整个图片选择器工具的实现思路大致如下：</p>
<ol>
<li>项目准备</li>
<li>解藕<code>Glide</code></li>
<li>实现列表浏览</li>
<li>实现原图浏览</li>
<li>与原页面交互实现选择</li>
</ol>
<h2>准备工作</h2>
<p>笔者使用的是<code>AndroidStudio</code> + <code>kotlin</code>开发(<em>Java是不可能Java的</em>)，并且目标是一个第三方库而不是完整应用。</p>
<p>首先新建一个<code>Project</code>：</p>
<p><img src="/assets/images/201810/post-1.png" alt="新建Project" /></p>
<p>新建自带的这个应用作为试例应用取名叫<code>Sample</code>：</p>
<p><img src="/assets/images/201810/post-2.png" alt="新建Project" /></p>
<p>然后<code>File -&gt; New -&gt; New Module</code>创建出工具类自己的模块：</p>
<p><img src="/assets/images/201810/post-3.png" alt="新建Module" /></p>
<p>最终得到了这样一个目录结构：</p>
<p><img src="/assets/images/201810/post-4.png" alt="基本目录结构" /></p>
<h2>图片引擎</h2>
<p>Android中图片的处理是个危险操作，很容易浪费性能甚至导致应用崩溃，笔者因此深度依赖了<code>Glide</code>这个库来处理图片，不过作为第三方库想要使用<code>Glide</code>，自己再引入一个<code>Glide</code>就会显得多余，而应该在最外层应用中配置好<code>Glide</code>，引入的第三方库若以来<code>Glide</code>，也应该使用外层的<code>Glide</code>，这就需要将第三方库与<code>Glide</code>的耦合给解开。笔者最终采用的思路类似<code>Matisse</code>，就是外层应用需要配置一个代码片段来传入并告诉我们的图片选择工具如何使用<code>Glide</code>。</p>
<p>图片选择器需要准备一个结构体，来放置一些图片渲染的回调方法：</p>
<pre><code class="language-kotlin">var setOrigin: ((context: Context, src: File, width: Int, height: Int, callback: (Bitmap) -&gt; Unit) -&gt; Unit)? = null
var setCommon: ((context: Context, imageView: ImageView, src: File) -&gt; Unit)? = null
var setThumb: ((context: Context, imageView: ImageView, src: File, size: Int, fade: Int, holderRes: Int) -&gt; Unit)? = null
var pauseGlide: ((context: Context) -&gt; Unit)? = null
var resumeGlide: ((context: Context) -&gt; Unit)? = null
</code></pre>
<p>其中<code>setOrigin</code>用于设置原图图片，<code>setCommon</code>用于直接设置图片作为通用方法，<code>setThumb</code>用于设置封面图，<code>pauseGlide</code>与<code>resumeGlide</code>方法用于帮助在页面滚动时暂停和继续<code>Glide</code>的渲染工作以避免此类卡顿情况。</p>
<p>最终应用中必须在某处(比如<code>BaseApplication</code>)执行一个代码片段，来将<code>Glide</code>配置给图片选择工具：</p>
<pre><code class="language-kotlin">Ymager.setOrigin = fun (context: Context, src: File, width: Int, height: Int, callback: (Bitmap) -&gt; Unit) {
    GlideApp.with(context).asBitmap().load(src).override(width, height).fitCenter().into(object: SimpleTarget&lt;Bitmap&gt;() {
        override fun onResourceReady(resource: Bitmap, transition: Transition&lt;in Bitmap&gt;?) {
            callback(resource)
        }
    })
}
Ymager.setCommon = fun (context: Context, imageView: ImageView, src: File) {
    GlideApp.with(context).load(src).into(imageView)
}
Ymager.setThumb = fun (context: Context, imageView: ImageView, src: File, size: Int, fade: Int, holderRes: Int) {
    GlideApp.with(context)
            .load(src)
            .error(holderRes)
            .transition(DrawableTransitionOptions.withCrossFade(fade))
            .override(size, size)
            .into(imageView)
}
Ymager.pauseGlide = fun (context: Context) {
    GlideApp.with(context).pauseRequests()
}
Ymager.resumeGlide = fun (context: Context) {
    GlideApp.with(context).resumeRequests()
}
</code></pre>
<p>对于笔者的这个图片选择器来说，应用中配置的方法内容很固定，每个渲染方法各自用于选择器中的一处需要渲染图片的地方，包括列表图片、相册封面以及原图。</p>
<h2>图片数据库工具类</h2>
<p>图片选择器使用的数据源是系统相册数据库，这就需要执行数据库查询语句了，所以需要准备这么一个<a href="https://github.com/yitimo/ymage/blob/master/ymage/src/main/java/com/yitimo/ymage/DBUtils.kt">数据库工具类</a>，包含了如下方法：</p>
<ul>
<li>queryAlbums -&gt; 查询所有的图片集，或者叫相册，Android中叫做<code>Bucket</code></li>
<li>query -&gt; 查询所有的图片，支持指定某个图片集</li>
<li>queryChosen -&gt; 传入默认选中的图片地址列表，查询出这些图片</li>
<li>first -&gt; 查询第一张图片，用于作为<code>全部</code>这个<code>Bucket</code>的封面</li>
</ul>
<h2>列表展示</h2>
<p>列表展示需要以每行固定格子数的形式来展示比较小的图片列表，所以要使用的是<code>RecyclerView</code>搭配<code>GridLayoutManager</code>，列表数据传入<code>Cursor</code>来动态的从数据库中取出图片数据，而不是一口气取出成百上千张图片数据，再一口气传入<code>Adapter</code>中。</p>
<p>与通常<code>RecyclerView</code>使用的<code>adapter</code>的不同在于，列表使用的<code>adapter</code>传入的是一个数据库查询得到的<code>Cursor</code>。</p>
<p>具体代码实现在<a href="https://github.com/yitimo/ymage/blob/master/ymage/src/main/java/com/yitimo/ymage/ListAdapter.kt">这里</a>。</p>
<h2>原图展示</h2>
<p>原图展示需要全屏显示某张图片，并支持缩放和左右切换图片。所以使用了<code>ViewPager</code>搭配<code>PagerAdapter</code>来实现。同样是传入<code>Cursor</code>，动态根据<code>position</code>取出图片信息并渲染。</p>
<p>具体代码实现在<a href="https://github.com/yitimo/ymage/blob/master/ymage/src/main/java/com/yitimo/ymage/OriginAdapter.kt">这里</a>。</p>
<h2>总结</h2>
<p>剩余的工作包含了：</p>
<ol>
<li><code>Bucket</code>列表的展示与切换，即根据<code>BucketId</code>来查询数据并使用第一张图作为封面。切换相册即只查询指定<code>BucketId</code>图片列表的<code>Cursor</code>并更新到<code>ListAdapter</code>。</li>
<li>选好图片后，通过intent传递选中的图片数据。</li>
<li>发布到<code>bintray</code>的流程，这个网上有很多了，大体就是<code>注册 -&gt; 创建项目 -&gt; 配置自己的项目 -&gt; 执行项目</code>这几步完事。</li>
</ol>
<p>完整项目的<code>Github</code>地址在<a href="https://github.com/yitimo/ymage">这里</a>。</p>
</div>
</body>
</html>